<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Forex Trading Journal</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- FullCalendar (v5 UMD) -->
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

  <!-- TradingView -->
  <script src="https://s3.tradingview.com/tv.js"></script>

  <style>
    body { padding: 1.25rem; background:#f8f9fa; }
    .card { box-shadow: 0 6px 18px rgba(0,0,0,.04); }
    .small-muted { font-size: .85rem; color: #6c757d; }
    .cal-day { border-radius:6px }
    .fc-event-profit { background:#e6f8ee !important; border-color:#bde6c9 !important; color:#0b532d !important; }
    .fc-event-loss { background:#fdecea !important; border-color:#f3b7b0 !important; color:#6b0f0f !important; }
    .fc-event-zero { background:#f1f3f5 !important; border-color:#d6d8db !important; color:#495057 !important; }
    #tv_chart_container{width:100%;height:640px;border-radius:6px;overflow:hidden;background:#fff}
    .legend .swatch { display:inline-block;width:14px;height:14px;margin-right:6px;border-radius:3px;vertical-align:middle; }
    .sw-green{background:#2ecc71} .sw-red{background:#e74c3c} .sw-gray{background:#adb5bd} .sw-white{background:#ffffff;border:1px solid #e9ecef}
  </style>
</head>
<body>
<div class="container">

  <div class="d-flex justify-content-between align-items-center mb-3">
    <h1 class="h4">Forex Trading Journal</h1>
    <div>
      <button id="btnSetup" class="btn btn-sm btn-outline-primary">Setup</button>
      <button id="btnAdd" class="btn btn-sm btn-success">Add Trade</button>
      <button id="btnImport" class="btn btn-sm btn-outline-secondary">Import File</button>
      <button id="btnExport" class="btn btn-sm btn-outline-dark">Export CSV</button>
      <button id="btnClear" class="btn btn-sm btn-outline-danger">Clear All</button>
    </div>
  </div>

  <!-- Tabs -->
  <ul class="nav nav-tabs" id="mainTabs" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" id="journal-tab" data-bs-toggle="tab" data-bs-target="#journal" type="button" role="tab">Journal</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="charts-tab" data-bs-toggle="tab" data-bs-target="#charts" type="button" role="tab">Charts</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="calendar-tab" data-bs-toggle="tab" data-bs-target="#calendarTab" type="button" role="tab">Calendar</button>
    </li>
  </ul>

  <div class="tab-content mt-3">

    <!-- JOURNAL TAB -->
    <div class="tab-pane fade show active" id="journal" role="tabpanel">
      <div class="row g-3">
        <div class="col-lg-8">
          <div class="card mb-3">
            <div class="card-body">
              <h6 class="card-title">Summary</h6>
              <div class="row">
                <div class="col-6 col-md-3 mb-2"><div><strong>Total Trades</strong><div id="statTotal">0</div></div></div>
                <div class="col-6 col-md-3 mb-2"><div><strong>Win Rate</strong><div id="statWinRate">0%</div></div></div>
                <div class="col-6 col-md-3 mb-2"><div><strong>Net P/L (<span id="currSymbol">$</span>)</strong><div id="statNet">$0.00</div></div></div>
                <div class="col-6 col-md-3 mb-2"><div><strong>Cumulative Pips</strong><div id="statPips">0</div></div></div>
                <div class="col-6 col-md-3 mb-2"><div><strong>Avg Win (<span id="currSymbol2">$</span>)</strong><div id="statAvgWin">$0.00</div></div></div>
                <div class="col-6 col-md-3 mb-2"><div><strong>Avg Loss (<span id="currSymbol3">$</span>)</strong><div id="statAvgLoss">$0.00</div></div></div>
                <div class="col-6 col-md-3 mb-2"><div><strong>Expectancy (<span id="currSymbol4">$</span>/trade)</strong><div id="statExpectancy">$0.00</div></div></div>
                <div class="col-6 col-md-3 mb-2"><div><strong>Current Balance</strong><div id="statBalance">$0.00</div></div></div>
              </div>

              <div class="row mt-2">
                <div class="col-md-6">
                  <label class="form-label small">Starting Balance (<span id="currSymbol5">$</span>)</label>
                  <div class="input-group input-group-sm">
                    <input id="startingBalance" class="form-control form-control-sm" type="number" step="0.01" placeholder="e.g. 10000">
                    <button id="saveBalance" class="btn btn-sm btn-outline-primary">Save</button>
                  </div>
                  <div class="small-muted mt-1">Balance is used to compute equity curve (starting balance + cumulative net P/L).</div>
                </div>
                <div class="col-md-6">
                  <label class="form-label small">Monthly Goal (<span id="currSymbol6">$</span>)</label>
                  <div class="input-group input-group-sm mb-1">
                    <input id="monthlyGoal" class="form-control form-control-sm" type="number" step="0.01" placeholder="e.g. 2000">
                    <button id="saveGoal" class="btn btn-sm btn-outline-primary">Save</button>
                  </div>
                  <div class="small-muted">Progress towards monthly profit goal</div>
                  <div class="progress progress-small mt-2"><div id="goalProgress" class="progress-bar" style="width:0%"></div></div>
                </div>
              </div>

            </div>
          </div>

          <div class="card mb-3">
            <div class="card-body">
              <h6 class="card-title">Equity Curve</h6>
              <canvas id="equityChart" height="120"></canvas>
            </div>
          </div>

          <div class="card mb-3">
            <div class="card-body d-flex">
              <div style="flex:1">
                <h6 class="card-title">P/L by Pair</h6>
                <canvas id="pairChart" height="120"></canvas>
              </div>
              <div style="width:260px;margin-left:18px">
                <h6 class="card-title">Pips by Pair</h6>
                <canvas id="pipsChart" height="120"></canvas>
              </div>
            </div>
          </div>
        </div>

        <div class="col-lg-4">
          <div class="card mb-3">
            <div class="card-body">
              <h6 class="card-title">Quick Add</h6>
              <form id="quickForm">
                <div class="mb-2"><input class="form-control form-control-sm" name="pair" placeholder="Pair (EUR/USD)" required></div>
                <div class="mb-2 d-flex gap-2">
                  <input class="form-control form-control-sm" name="direction" placeholder="Buy/Sell" required>
                  <input class="form-control form-control-sm" name="profit_loss" placeholder="Profit/Loss ($)" required>
                </div>
                <button class="btn btn-sm btn-primary" type="submit">Add</button>
                <button id="openCalc" type="button" class="btn btn-sm btn-outline-secondary ms-2">Position Size Calc</button>
              </form>
            </div>
          </div>

          <div class="card">
            <div class="card-body">
              <h6 class="card-title">Recent Trades</h6>
              <ul id="recentList" class="list-group list-group-flush small"></ul>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- CHARTS TAB -->
    <div class="tab-pane fade" id="charts" role="tabpanel">
      <div class="card mb-3">
        <div class="card-body d-flex align-items-center gap-3">
          <label class="small-muted mb-0">Symbol</label>
          <select id="tvSymbol" class="form-select form-select-sm" style="width:200px">
            <option value="FX:EURUSD" selected>EUR/USD</option>
            <option value="FX:GBPUSD">GBP/USD</option>
            <option value="FX:USDJPY">USD/JPY</option>
            <option value="OANDA:XAUUSD">XAU/USD</option>
            <option value="BITSTAMP:BTCUSD">BTC/USD</option>
          </select>
          <button id="loadTV" class="btn btn-sm btn-primary">Load Chart</button>
          <div class="ms-auto small-muted">Data powered by TradingView</div>
        </div>
      </div>

      <div class="card">
        <div class="card-body">
          <div id="tv_chart_container"></div>
        </div>
      </div>
    </div>

    <!-- CALENDAR TAB -->
    <div class="tab-pane fade" id="calendarTab" role="tabpanel">
      <div class="card mb-3">
        <div class="card-body d-flex align-items-center">
          <h6 class="mb-0">Performance Calendar</h6>
          <div class="ms-auto legend small">
            <span class="swatch sw-green"></span><span class="me-2">Profit</span>
            <span class="swatch sw-red"></span><span class="me-2">Loss</span>
            <span class="swatch sw-gray"></span><span class="me-2">Break-even</span>
            <span class="swatch sw-white"></span><span>No trades</span>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-body">
          <div id="fc-calendar"></div>
        </div>
      </div>
    </div>

  </div>
</div>

<!-- Day modal (shows trades for clicked date) -->
<div class="modal fade" id="dayModal" tabindex="-1">
  <div class="modal-dialog modal-md">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="dayModalTitle">Trades on ...</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div id="dayTradesList" class="list-group small"></div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- Setup, Calc, Add/Edit trade modals (kept short for brevity; same inputs as before) -->
<!-- Position Size Calculator Modal -->
<div class="modal fade" id="calcModal" tabindex="-1">
  <div class="modal-dialog modal-sm">
    <div class="modal-content">
      <div class="modal-header"><h5 class="modal-title">Position Size Calculator</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
      <div class="modal-body">
        <div class="mb-2"><label class="form-label small">Account Balance (<span id="symCalc">$</span>)</label><input id="calcBalance" class="form-control form-control-sm" type="number" step="0.01"></div>
        <div class="mb-2"><label class="form-label small">Risk % per trade</label><input id="calcRisk" class="form-control form-control-sm" type="number" step="0.01" placeholder="e.g. 1"></div>
        <div class="mb-2"><label class="form-label small">Stop Loss (pips)</label><input id="calcSL" class="form-control form-control-sm" type="number" step="0.1" placeholder="e.g. 50"></div>
        <div class="mb-2"><label class="form-label small">Pip value per standard lot</label><input id="calcPipValue" class="form-control form-control-sm" type="number" step="0.01" value="10"></div>
        <div class="small-muted">Formula: lots = (Balance * risk%) / (SL * pipValue)</div>
        <div class="mt-2"><button id="runCalc" class="btn btn-sm btn-primary">Calculate</button></div>
        <div class="mt-2"><div id="calcResult" class="fw-semibold"></div></div>
      </div>
    </div>
  </div>
</div>

<!-- Setup Modal -->
<div class="modal fade" id="setupModal" tabindex="-1">
  <div class="modal-dialog modal-sm">
    <div class="modal-content">
      <div class="modal-header"><h5 class="modal-title">Quick Setup</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
      <div class="modal-body">
        <div class="mb-2"><label class="form-label small">Currency</label>
          <select id="baseCurrency" class="form-select form-select-sm"><option value="$">USD ($)</option><option value="€">EUR (€)</option><option value="£">GBP (£)</option><option value="¥">JPY (¥)</option></select>
        </div>
        <div class="mb-2"><label class="form-label small">Starting Year</label><input id="startYear" class="form-control form-control-sm" type="number" value="2025"></div>
        <div class="mb-2"><label class="form-label small">Starting Balance</label><input id="setupBalance" class="form-control form-control-sm" type="number" step="0.01"></div>
        <div class="mt-2"><button id="saveSetup" class="btn btn-sm btn-primary">Save</button></div>
      </div>
    </div>
  </div>
</div>

<!-- Add / Edit Trade Modal -->
<div class="modal fade" id="tradeModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalTitle">Add Trade</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="tradeForm">
          <input type="hidden" name="id">
          <div class="row g-2">
            <div class="col-md-3"><input class="form-control form-control-sm" name="date_open" placeholder="Date Open (YYYY-MM-DD)"></div>
            <div class="col-md-3"><input class="form-control form-control-sm" name="date_closed" placeholder="Date Closed (YYYY-MM-DD)"></div>
            <div class="col-md-3"><input class="form-control form-control-sm" name="pair" placeholder="Pair (EUR/USD)" required></div>
            <div class="col-md-3"><input class="form-control form-control-sm" name="direction" placeholder="Buy/Sell" required></div>
          </div>

          <div class="row g-2 mt-2">
            <div class="col-md-3"><input class="form-control form-control-sm" name="entry_price" placeholder="Entry Price"></div>
            <div class="col-md-3"><input class="form-control form-control-sm" name="exit_price" placeholder="Exit Price"></div>
            <div class="col-md-3"><input class="form-control form-control-sm" name="stop_loss" placeholder="Stop Loss"></div>
            <div class="col-md-3"><input class="form-control form-control-sm" name="take_profit" placeholder="Take Profit"></div>
          </div>

          <div class="row g-2 mt-2">
            <div class="col-md-2"><input class="form-control form-control-sm" name="lot_size" placeholder="Lot Size"></div>
            <div class="col-md-2"><input class="form-control form-control-sm" name="pips" placeholder="Pips"></div>
            <div class="col-md-3"><input class="form-control form-control-sm" name="profit_loss" placeholder="Gross P/L ($)" required></div>
            <div class="col-md-3"><input class="form-control form-control-sm" name="commission" placeholder="Commission ($)"></div>
            <div class="col-md-2"><input class="form-control form-control-sm" name="swap" placeholder="Swap ($)"></div>
          </div>

          <div class="mt-2"><input class="form-control form-control-sm" name="setup_type" placeholder="Setup Type"></div>
          <div class="mt-2"><input class="form-control form-control-sm" name="confluences" placeholder="Confluences"></div>
          <div class="mt-2"><textarea class="form-control form-control-sm" name="notes" rows="3" placeholder="Notes / Psychology"></textarea></div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Cancel</button>
        <button id="saveTrade" class="btn btn-primary btn-sm">Save</button>
      </div>
    </div>
  </div>
</div>

<input type="file" id="fileInput" accept=".csv,.html,text/csv" style="display:none">

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
/* ======= Journal core + Calendar integration ======= */
const STORAGE_KEY = 'forex_journal_calendar_v3';
const SETTINGS_KEY = 'forex_journal_settings_v3';
let trades = [];
let settings = { currencySymbol: '$', startingBalance: 0, monthlyGoal: 0, startYear: new Date().getFullYear() };
let calendar = null;
let tvWidget = null;

// Helpers
function uid(){return Date.now().toString(36)+Math.random().toString(36).slice(2,8)}
function fmtNumber(n){ return Number(n||0).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2}) }

// Load & Save
function load(){
  const raw = localStorage.getItem(STORAGE_KEY);
  trades = raw?JSON.parse(raw):[];
  const s = localStorage.getItem(SETTINGS_KEY);
  if(s) settings = JSON.parse(s);
  document.getElementById('startingBalance').value = settings.startingBalance||'';
  document.getElementById('monthlyGoal').value = settings.monthlyGoal||'';
  document.getElementById('baseCurrency').value = settings.currencySymbol||'$';
  document.getElementById('setupBalance').value = settings.startingBalance||'';
  document.getElementById('startYear').value = settings.startYear||new Date().getFullYear();
  updateCurrencySymbols();
}
function save(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(trades)); localStorage.setItem(SETTINGS_KEY, JSON.stringify(settings)); renderAll(); }

// CRUD
function addTrade(t){ t.id = t.id || uid(); t.profit_loss = Number(t.profit_loss||0); t.commission = Number(t.commission||0); t.swap = Number(t.swap||0); t.profit_loss_net = Number(t.profit_loss) - Number(t.commission) - Number(t.swap); t.pips = Number(t.pips||computePips(t.pair,t.entry_price,t.exit_price,t.direction)); trades.push(t); save(); }
function updateTrade(updated){ updated.profit_loss = Number(updated.profit_loss||0); updated.commission = Number(updated.commission||0); updated.swap = Number(updated.swap||0); updated.profit_loss_net = Number(updated.profit_loss) - Number(updated.commission) - Number(updated.swap); trades = trades.map(t=> t.id===updated.id? updated: t); save(); }
function deleteTrade(id){ trades = trades.filter(t=>t.id!==id); save(); }

// Pips helper
function pipMultiplier(pair){ if(!pair) return 10000; const p = pair.toUpperCase(); if(p.includes('JPY')) return 100; return 10000; }
function computePips(pair, entry, exit, direction){ const e=Number(entry), x=Number(exit); if(!e||!x) return 0; const mult=pipMultiplier(pair); let p=(x-e)*mult; if(direction && direction.toLowerCase().startsWith('sell')) p = -p; return Math.round(p*100)/100; }

// Stats & Charts (Chart.js)
let equityChart=null, pairChart=null, pipsChart=null;
function computeStats(){
  const total = trades.length;
  const profits = trades.map(t=>Number(t.profit_loss_net||0));
  const wins = profits.filter(p=>p>0);
  const losses = profits.filter(p=>p<=0);
  const net = profits.reduce((a,b)=>a+b,0);
  const winRate = total? (wins.length/total)*100 : 0;
  const avgWin = wins.length? wins.reduce((a,b)=>a+b,0)/wins.length : 0;
  const avgLoss = losses.length? losses.reduce((a,b)=>a+b,0)/losses.length : 0;
  const expectancy = total? ((avgWin*(wins.length/total)) + (avgLoss*(losses.length/total))) : 0;
  const totalPips = trades.reduce((acc,t)=> acc + (Number(t.pips)||0),0);
  const sorted = trades.slice().sort((a,b)=> (a.date_closed||a.date_open||'').localeCompare(b.date_closed||b.date_open||''));
  let running=0; const labels=[]; const cum=[];
  for(const t of sorted){ running += Number(t.profit_loss_net||0); labels.push(t.date_closed||t.date_open||''); cum.push(Number(running.toFixed(2))); }
  const bypair={}; const pipsByPair={};
  for(const t of trades){ bypair[t.pair] = (bypair[t.pair]||0) + Number(t.profit_loss_net||0); pipsByPair[t.pair] = (pipsByPair[t.pair]||0) + Number(t.pips||0); }
  return { total, net, winRate, avgWin, avgLoss, expectancy, totalPips, equity:{labels,cum}, bypair, pipsByPair };
}
function renderStatsAndCharts(){
  const s = computeStats();
  document.getElementById('statTotal').textContent = s.total;
  document.getElementById('statWinRate').textContent = s.winRate.toFixed(2) + '%';
  document.getElementById('statNet').textContent = settings.currencySymbol + fmtNumber(s.net);
  document.getElementById('statPips').textContent = (Math.round(s.totalPips*100)/100).toString();
  document.getElementById('statAvgWin').textContent = settings.currencySymbol + fmtNumber(s.avgWin);
  document.getElementById('statAvgLoss').textContent = settings.currencySymbol + fmtNumber(s.avgLoss);
  document.getElementById('statExpectancy').textContent = settings.currencySymbol + fmtNumber(s.expectancy);
  document.getElementById('statBalance').textContent = settings.currencySymbol + fmtNumber((settings.startingBalance || 0) + (s.equity.cum.length ? s.equity.cum[s.equity.cum.length-1] : 0) );

  // goal progress
  const currentMonth = (new Date()).toISOString().slice(0,7);
  const monthlySum = trades.filter(t=> (t.date_closed||t.date_open||'').slice(0,7) === currentMonth).reduce((a,b)=> a + Number(b.profit_loss_net||0), 0);
  const goal = Number(settings.monthlyGoal||0);
  const pct = goal>0 ? Math.max(0, Math.min(100, (monthlySum/goal)*100)) : 0;
  document.getElementById('goalProgress').style.width = pct + '%';
  document.getElementById('goalProgress').textContent = pct? Math.round(pct) + '%':'';

  // equity chart
  const eqCtx = document.getElementById('equityChart');
  if(equityChart) equityChart.destroy();
  equityChart = new Chart(eqCtx, { type:'line', data:{ labels:s.equity.labels, datasets:[{label:'Account Balance ('+settings.currencySymbol+')', data:s.equity.cum.map(v=> (settings.startingBalance || 0) + v ), tension:0.25, fill:false}] }, options:{scales:{y:{beginAtZero:false}}} });

  // P/L by pair
  const pairLabels = Object.keys(s.bypair);
  const pairData = pairLabels.map(k=>Number(s.bypair[k].toFixed(2)));
  const pairCtx = document.getElementById('pairChart');
  if(pairChart) pairChart.destroy();
  pairChart = new Chart(pairCtx, { type:'bar', data:{ labels:pairLabels, datasets:[{label:'P/L by Pair ('+settings.currencySymbol+')', data:pairData}] }, options:{ indexAxis:'y' } });

  // Pips by pair
  const pipsLabels = Object.keys(s.pipsByPair);
  const pipsData = pipsLabels.map(k=>Math.round((s.pipsByPair[k]||0)*100)/100);
  const pipsCtx = document.getElementById('pipsChart');
  if(pipsChart) pipsChart.destroy();
  pipsChart = new Chart(pipsCtx, { type:'bar', data:{ labels:pipsLabels, datasets:[{label:'Pips by Pair', data:pipsData}] }, options:{ indexAxis:'y' } });
}

// Calendar: aggregate trades by date (closed or open)
function buildCalendarEvents(){
  // daily aggregate: date -> {pl, count, trades[]}
  const daily = {};
  trades.forEach(t=>{
    const d = (t.date_closed || t.date_open || '').slice(0,10);
    if(!d) return;
    if(!daily[d]) daily[d] = { pl:0, count:0, trades:[] };
    daily[d].pl += Number(t.profit_loss_net||0);
    daily[d].count += 1;
    daily[d].trades.push(t);
  });

  const events = [];
  for(const date in daily){
    const info = daily[date];
    const title = `${settings.currencySymbol}${fmtNumber(info.pl)} (${info.count})`;
    const cls = Math.abs(info.pl) < 0.000001 ? 'fc-event-zero' : (info.pl > 0 ? 'fc-event-profit' : 'fc-event-loss');
    events.push({
      title,
      start: date,
      allDay: true,
      extendedProps: { trades: info.trades, pl: info.pl, count: info.count },
      className: cls
    });
  }
  return events;
}

function initCalendar(){
  const calendarEl = document.getElementById('fc-calendar');
  if(calendar) calendar.destroy();
  calendar = new FullCalendar.Calendar(calendarEl, {
    initialView: 'dayGridMonth',
    height: 650,
    headerToolbar: { left:'prev,next today', center:'title', right:'' },
    events: buildCalendarEvents(),
    eventClick: function(info){
      const date = info.event.startStr;
      const tradesList = info.event.extendedProps.trades || [];
      showDayModal(date, tradesList);
    }
  });
  calendar.render();
}

// Day modal
const dayModal = new bootstrap.Modal(document.getElementById('dayModal'));
function showDayModal(dateStr, tradesList){
  document.getElementById('dayModalTitle').textContent = `Trades on ${dateStr}`;
  const holder = document.getElementById('dayTradesList');
  holder.innerHTML = '';
  if(!tradesList || tradesList.length===0){ holder.innerHTML = `<div class="text-muted">No trades on this date.</div>`; }
  else {
    tradesList.forEach(t=>{
      const item = document.createElement('div');
      item.className = 'list-group-item';
      item.innerHTML = `
        <div class="d-flex justify-content-between align-items-start">
          <div>
            <div class="fw-semibold">${t.pair || ''} — ${t.direction || ''}</div>
            <div class="small-muted">${t.date_open || ''} → ${t.date_closed || ''} • ${t.pips || 0} pips</div>
            <div class="small mt-1">${(t.notes || '').slice(0,220)}</div>
          </div>
          <div class="text-end">
            <div class="${Number(t.profit_loss_net) >= 0 ? 'text-success' : 'text-danger'} fw-bold">${settings.currencySymbol}${fmtNumber(t.profit_loss_net)}</div>
            <div class="small-muted">Gross ${settings.currencySymbol}${fmtNumber(t.profit_loss||0)} • Comm ${settings.currencySymbol}${fmtNumber(t.commission||0)}</div>
          </div>
        </div>
      `;
      holder.appendChild(item);
    });
  }
  dayModal.show();
}

// Import/Export & MT HTML parser (best-effort)
function exportCSV(){
  const header = ["id","ticket","date_open","date_closed","pair","direction","lot_size","entry_price","exit_price","stop_loss","take_profit","pips","profit_loss","commission","swap","setup_type","confluences","confidence","notes"];
  const rows = trades.map(t=> header.map(h=> (t[h]||'') ));
  const csv = [header.join(',')].concat(rows.map(r=> r.map(cell=> '"'+String(cell).replace(/"/g,'""')+'"').join(','))).join('\n');
  const blob = new Blob([csv],{type:'text/csv;charset=utf-8;'}); const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download = 'forex_trades_export.csv'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
}

function importCSV(text){
  const lines = text.split(/\r?\n/).filter(Boolean);
  if(lines.length<2) return alert('No data found');
  const header = lines[0].split(',').map(h=>h.replace(/^"|"$/g,'').trim());
  const newTrades = lines.slice(1).map(l=>{
    const cols = []; let cur=''; let inq=false;
    for(let i=0;i<l.length;i++){ const ch=l[i]; if(ch==='"'){ if(inq && l[i+1]==='"'){ cur+='"'; i++; } else inq=!inq; } else if(ch===',' && !inq){ cols.push(cur); cur=''; } else cur+=ch; } cols.push(cur);
    const obj = {}; header.forEach((h,idx)=> obj[h] = cols[idx] ? cols[idx].replace(/^"|"$/g,'') : '');
    obj.id = obj.id || uid(); obj.profit_loss = Number(obj.profit_loss||0); obj.commission = Number(obj.commission||0); obj.swap = Number(obj.swap||0); obj.pips = Number(obj.pips||0); obj.profit_loss_net = Number(obj.profit_loss) - Number(obj.commission) - Number(obj.swap);
    return obj;
  });
  trades = trades.concat(newTrades); save();
}

function parseMTReportHTML(html){
  try{
    const parser = new DOMParser();
    const doc = parser.parseFromString(html, 'text/html');
    const tables = Array.from(doc.querySelectorAll('table'));
    let found = null;
    for(const table of tables){
      const headerCells = Array.from(table.querySelectorAll('tr')).map(r=> Array.from(r.querySelectorAll('th,td')).map(c=>c.textContent.trim().toLowerCase()));
      for(const row of headerCells){
        const joined = row.join('|');
        if(joined.includes('profit') && (joined.includes('open') || joined.includes('type') || joined.includes('symbol') || joined.includes('price'))){
          found = table; break;
        }
      }
      if(found) break;
    }
    if(!found) return alert('Could not find trade table in the HTML file. Export "Account History -> Save as Report" from MT4/MT5 and try again.');
    const headerRow = Array.from(found.querySelectorAll('tr')).find(r => Array.from(r.querySelectorAll('th,td')).some(c=>/profit/i.test(c.textContent)));
    const headerTexts = headerRow ? Array.from(headerRow.querySelectorAll('th,td')).map(c=>c.textContent.trim()) : [];
    const mapKey = h => {
      const t = (h||'').toLowerCase();
      if(/ticket|order/.test(t)) return 'ticket';
      if(/open/.test(t) && /time|date/.test(t)) return 'date_open';
      if(/close/.test(t) && /time|date/.test(t)) return 'date_closed';
      if(/symbol|item/.test(t)) return 'pair';
      if(/type/.test(t)) return 'direction';
      if(/size|lots|volume/.test(t)) return 'lot_size';
      if(/open price/.test(t) && !/close/.test(t)) return 'entry_price';
      if(/close price/.test(t) || (/price/.test(t) && /close/.test(t))) return 'exit_price';
      if(/s\/l/.test(t)) return 'stop_loss';
      if(/t\/p/.test(t)) return 'take_profit';
      if(/profit/.test(t)) return 'profit_loss';
      return h.replace(/\s+/g,'_').toLowerCase();
    };
    const headers = headerTexts.map(mapKey);
    const rows = Array.from(found.querySelectorAll('tr')).slice(1);
    const parsed = [];
    for(const r of rows){
      const cols = Array.from(r.querySelectorAll('td')).map(c=>c.textContent.trim());
      if(cols.length===0) continue;
      const obj = {};
      for(let i=0;i<Math.min(cols.length, headers.length); i++){
        obj[headers[i]] = cols[i];
      }
      if(obj.profit_loss) obj.profit_loss = Number(String(obj.profit_loss).replace(/[^0-9\-\.\,]/g,'').replace(',','.')) || 0;
      if(obj.entry_price) obj.entry_price = Number(String(obj.entry_price).replace(/[^0-9\-\.\,]/g,'').replace(',','.')) || 0;
      if(obj.exit_price) obj.exit_price = Number(String(obj.exit_price).replace(/[^0-9\-\.\,]/g,'').replace(',','.')) || 0;
      if(obj.pair) obj.pair = obj.pair.replace(/\s+/g,'').replace(/\./g,'/').toUpperCase();
      if(obj.date_closed) obj.date_closed = obj.date_closed.split(' ')[0];
      if(obj.date_open) obj.date_open = obj.date_open.split(' ')[0];
      obj.commission = Number(obj.commission||0);
      obj.swap = Number(obj.swap||0);
      obj.pips = Number(obj.pips|| computePips(obj.pair, obj.entry_price, obj.exit_price, obj.direction));
      obj.profit_loss_net = Number(obj.profit_loss) - Number(obj.commission) - Number(obj.swap);
      obj.id = uid();
      parsed.push(obj);
    }
    trades = trades.concat(parsed);
    save();
    alert('Imported HTML report — added ' + parsed.length + ' trades (best-effort).');
  }catch(err){
    console.error(err);
    alert('Failed to parse HTML report. See console for details.');
  }
}

// File input handling
const fileInput = document.getElementById('fileInput');
document.getElementById('btnImport').addEventListener('click', ()=> fileInput.click());
fileInput.addEventListener('change', e => {
  const f = e.target.files[0]; if(!f) return;
  const reader = new FileReader();
  reader.onload = () => {
    const text = reader.result;
    if(f.name.toLowerCase().endsWith('.csv')) importCSV(text);
    else if(f.name.toLowerCase().endsWith('.html') || /<html/i.test(text)) parseMTReportHTML(text);
    else {
      if(text.includes('<table') && /profit/i.test(text.toLowerCase())) parseMTReportHTML(text);
      else importCSV(text);
    }
  };
  reader.readAsText(f);
  fileInput.value = '';
});

// UI events and modals
const tradeModalEl = document.getElementById('tradeModal'); const tradeModal = new bootstrap.Modal(tradeModalEl);
function openAddModal(){ document.getElementById('modalTitle').textContent = 'Add Trade'; document.getElementById('tradeForm').reset(); document.querySelector('#tradeForm [name=id]').value = ''; tradeModal.show(); }
function openEditModal(id){ const t = trades.find(x=>x.id===id); if(!t) return; document.getElementById('modalTitle').textContent = 'Edit Trade'; const f = document.getElementById('tradeForm'); for(const k in t){ if(f.elements[k]) f.elements[k].value = t[k]; } document.querySelector('#tradeForm [name=id]').value = t.id; tradeModal.show(); }
document.getElementById('saveTrade').addEventListener('click', ()=>{
  const form = document.getElementById('tradeForm'); const data = {};
  for(const el of form.elements){ if(el.name){ data[el.name] = el.value; }}
  if(!data.pair || !data.direction) { alert('Pair and Direction required'); return; }
  data.profit_loss = Number(data.profit_loss || 0); data.commission = Number(data.commission || 0); data.swap = Number(data.swap || 0);
  data.pips = Number(data.pips || computePips(data.pair, data.entry_price, data.exit_price, data.direction));
  if(data.id) updateTrade(data); else addTrade(data);
  tradeModal.hide();
});

document.getElementById('btnAdd').addEventListener('click', openAddModal);
document.getElementById('btnClear').addEventListener('click', ()=>{ if(confirm('Clear all trades? This cannot be undone.')){ trades=[]; save(); }});
document.getElementById('btnExport').addEventListener('click', exportCSV);
document.getElementById('quickForm').addEventListener('submit', e=>{ e.preventDefault(); const fd = new FormData(e.target); const data = { id: uid(), date_open: new Date().toISOString().slice(0,10), date_closed: new Date().toISOString().slice(0,10), pair: fd.get('pair'), direction: fd.get('direction'), profit_loss: Number(fd.get('profit_loss')||0), commission:0, swap:0, pips:0 }; addTrade(data); e.target.reset(); });

// Position calc modal
const calcModal = new bootstrap.Modal(document.getElementById('calcModal'));
document.getElementById('openCalc').addEventListener('click', ()=>{ document.getElementById('calcBalance').value = settings.startingBalance || ''; document.getElementById('calcRisk').value = 1; document.getElementById('calcSL').value = 50; document.getElementById('calcPipValue').value = 10; calcModal.show(); });
document.getElementById('runCalc').addEventListener('click', ()=>{ const bal = Number(document.getElementById('calcBalance').value||0); const riskPct = Number(document.getElementById('calcRisk').value||0)/100; const sl = Number(document.getElementById('calcSL').value||0); const pipVal = Number(document.getElementById('calcPipValue').value||10); if(!bal || !sl || !pipVal){ alert('Please enter balance, stop loss and pip value'); return; } const riskAmt = bal * riskPct; const lots = riskAmt / (sl * pipVal); document.getElementById('calcResult').textContent = `Risk ${settings.currencySymbol}${fmtNumber(riskAmt)} → Suggested lot size: ${lots.toFixed(3)} lots`; });

// Setup modal
const setupModal = new bootstrap.Modal(document.getElementById('setupModal'));
document.getElementById('btnSetup').addEventListener('click', ()=> setupModal.show());
document.getElementById('saveSetup').addEventListener('click', ()=>{ settings.currencySymbol = document.getElementById('baseCurrency').value || '$'; settings.startYear = Number(document.getElementById('startYear').value||new Date().getFullYear()); settings.startingBalance = Number(document.getElementById('setupBalance').value||0); document.getElementById('startingBalance').value = settings.startingBalance; updateCurrencySymbols(); save(); setupModal.hide(); alert('Setup saved'); });
document.getElementById('saveBalance').addEventListener('click', ()=>{ settings.startingBalance = Number(document.getElementById('startingBalance').value||0); save(); alert('Starting balance saved'); });
document.getElementById('saveGoal').addEventListener('click', ()=>{ settings.monthlyGoal = Number(document.getElementById('monthlyGoal').value||0); save(); alert('Monthly goal saved'); });

function updateCurrencySymbols(){ const sym = settings.currencySymbol || '$'; document.querySelectorAll('#currSymbol,#currSymbol2,#currSymbol3,#currSymbol4,#currSymbol5,#currSymbol6,#symCalc').forEach(el=>el.textContent = sym); }

// TradingView embed
function loadTradingView(symbol){
  // destroy previous if exists
  document.getElementById('tv_chart_container')?.remove?.();
  const container = document.createElement('div'); container.id = 'tv_chart_container'; container.style.width='100%'; container.style.height='640px';
  const parent = document.querySelector('#charts .card-body');
  if(parent) parent.appendChild(container);
  try{
    if(tvWidget) { try{ tvWidget.remove(); } catch(e){} }
    tvWidget = new TradingView.widget({
      "width": "100%",
      "height": "640",
      "symbol": symbol,
      "interval": "60",
      "timezone": "Etc/UTC",
      "theme": "light",
      "style": "1",
      "locale": "en",
      "toolbar_bg": "#f1f3f6",
      "enable_publishing": false,
      "container_id": "tv_chart_container"
    });
  } catch(e){
    console.warn('TradingView init failed', e);
  }
}
document.getElementById('loadTV').addEventListener('click', ()=> loadTradingView(document.getElementById('tvSymbol').value));
loadTradingView(document.getElementById('tvSymbol').value);

// Render all (stats, charts, calendar, recents)
function renderAll(){
  renderStatsAndCharts();
  initCalendar();
  // recent list
  const recent = trades.slice().sort((a,b)=> (b.date_closed||b.date_open||'').localeCompare(a.date_closed||a.date_open||'')).slice(0,6);
  const recentList = document.getElementById('recentList'); recentList.innerHTML='';
  for(const r of recent){
    const li = document.createElement('li'); li.className='list-group-item';
    li.innerHTML = `<div><strong>${r.pair}</strong> — ${r.direction} — ${settings.currencySymbol}${fmtNumber(r.profit_loss_net)}</div><div class="small-muted">${r.date_closed||r.date_open||''}</div>`;
    recentList.appendChild(li);
  }
}

// Init
load();
renderAll();
</script>
</body>
</html>
